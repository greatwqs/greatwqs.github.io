---
layout: post
title: WordPress 归档页面模板[WP原生函数实现2014版]
date: 2014-10-31 13:31
author: 老杨
comments: true
categories: [Wordpress 文章归档, 信息技术]
---
WordPress 归档页面模板，效果可参考 <a href="/archives" target="_blank">归档</a> 页面。

教程来自 <a href="http://zww.me/wordpress-archive-page-template-wp-primary-function-2014-edition.z-turn" rel="nofollow" target="_blank">zww 大叔</a>，下面是实现方法。

<!--more-->


<h3>1. 归档函数</h3>

下面代码放到主题文件 functions.php 里面，另外注意代码里面有中文，所以要把 functions.php 文件编码改为 UTF8 无 BOM 格式。
<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">/* Archives list v2014 by zwwooooo 
 http://zww.me */<br>function zww_archives_list() {<br>	if( !$output = get_option('zww_db_cache_archives_list') ){<br>		$output = '<span style="color:#170">&lt;div</span> <span style="color:#00c">id</span>=<span style="color:#a11">"archives"</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;p</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;a</span> <span style="color:#00c">id</span>=<span style="color:#a11">"al_expand_collapse"</span> <span style="color:#00c">href</span>=<span style="color:#a11">"#"</span><span style="color:#170">&gt;</span>全部展开/收缩<span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span> <span style="color:#170">&lt;em</span><span style="color:#170">&gt;</span>(注: 点击月份可以展开)<span style="color:#170">&lt;/em</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span>';<br>		$args = array(<br>			'post_type' =&gt; 'post', //如果你有多个 post type，可以这样 array('post', 'product', 'news')  <br>			'posts_per_page' =&gt; -1, //全部 posts<br>			'ignore_sticky_posts' =&gt; 1 //忽略 sticky posts<br><br>		);<br>		$the_query = new WP_Query( $args );<br>		$posts_rebuild = array();<br>		$year = $mon = 0;<br>		while ( $the_query-&gt;have_posts() ) : $the_query-&gt;the_post();<br>			$post_year = get_the_time('Y');<br>			$post_mon = get_the_time('m');<br>			$post_day = get_the_time('d');<br>			if ($year != $post_year) $year = $post_year;<br>			if ($mon != $post_mon) $mon = $post_mon;<br>			$posts_rebuild[$year][$mon][] = '<span style="color:#170">&lt;li</span><span style="color:#170">&gt;</span>'. get_the_time('d日: ') .'<span style="color:#170">&lt;a</span> <span style="color:#00c">href</span>=<span style="color:#a11">"'. get_permalink() .'"</span><span style="color:#170">&gt;</span>'. get_the_title() .'<span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span> <span style="color:#170">&lt;em</span><span style="color:#170">&gt;</span>('. get_comments_number('0', '1', '%') .')<span style="color:#170">&lt;/em</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/li</span><span style="color:#170">&gt;</span>';<br>		endwhile;<br>		wp_reset_postdata();<br><br>		foreach ($posts_rebuild as $key_y =&gt; $y) {<br>			$output .= '<span style="color:#170">&lt;h3</span> <span style="color:#00c">class</span>=<span style="color:#a11">"al_year"</span><span style="color:#170">&gt;</span>'. $key_y .' 年<span style="color:#170">&lt;/h3</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;ul</span> <span style="color:#00c">class</span>=<span style="color:#a11">"al_mon_list"</span><span style="color:#170">&gt;</span>'; //输出年份<br>			foreach ($y as $key_m =&gt; $m) {<br>				$posts = ''; $i = 0;<br>				foreach ($m as $p) {<br>					++$i;<br>					$posts .= $p;<br>				}<br>				$output .= '<span style="color:#170">&lt;li</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;span</span> <span style="color:#00c">class</span>=<span style="color:#a11">"al_mon"</span><span style="color:#170">&gt;</span>'. $key_m .' 月 <span style="color:#170">&lt;em</span><span style="color:#170">&gt;</span> ( '. $i .' 篇文章 )<span style="color:#170">&lt;/em</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/span</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;ul</span> <span style="color:#00c">class</span>=<span style="color:#a11">"al_post_list"</span><span style="color:#170">&gt;</span>'; //输出月份<br>				$output .= $posts; //输出 posts<br>				$output .= '<span style="color:#170">&lt;/ul</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/li</span><span style="color:#170">&gt;</span>';<br>			}<br>			$output .= '<span style="color:#170">&lt;/ul</span><span style="color:#170">&gt;</span>';<br>		}<br><br>		$output .= '<span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span>';<br>		update_option('zww_db_cache_archives_list', $output);<br>	}<br>	echo $output;<br>}<br>function clear_db_cache_archives_list() {<br>	update_option('zww_db_cache_archives_list', ''); // 清空 zww_archives_list<br>}<br>add_action('save_post', 'clear_db_cache_archives_list'); // 新发表文章/修改文章时</pre>

PS: 因为查询度有点大，所以有加数据库缓存，只在文章发表/修改时才会更新缓存数据，所以测试时，可以特意去后台点“快速编辑”文章然后点更新就可以更新缓存数据。
<h3>2. 复制一份主题的 page.php 更名为 archives.php，然后在最顶端加入：</h3>
<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#555">&lt;?php</span><br><span style="color:#a50">/*</span><br><span style="color:#a50">Template Name: Archives</span><br><span style="color:#a50">*/</span><br><span style="color:#555">?&gt;</span></pre>

在 archives.php 找到类似 <?php content(); ?>，在其下面加入如下代码

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"><span style="color:#555">&lt;?php</span> <span style="color:#@cm-word">zww_archives_list</span>(); <span style="color:#555">?&gt;</span></pre>

然后新建页面（如叫：归档），选择模版为 Archives
<h3>3. 给主题加载 jQuery 库，没有加载的，把下面这句扔到 functions.php 里面就行了。</h3>

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">wp_enqueue_script('jquery');</pre>

<h3>4. jQuery 代码：</h3>
这次玩了逐个下拉/收缩效果，想着很好，但我博客感觉效果一般，因为文章太多了...如果文章不多，可以把代码里面 2 个 (s-10<1)?0:s-10 改为 s，效果会好看点。
<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">(<span style="color:#708">function</span> (<span style="color:#00f">$</span>, <span style="color:#00f">window</span>) {<br>	<span style="color:#000-2">$</span>(<span style="color:#708">function</span>() {<br>		<span style="color:#708">var</span> <span style="color:#00f">$a</span> = <span style="color:#000-2">$</span>(<span style="color:#a11">'#archives'</span>),<br>			<span style="color:#00f">$m</span> = <span style="color:#000-2">$</span>(<span style="color:#a11">'.al_mon'</span>, <span style="color:#000-2">$a</span>),<br>			<span style="color:#00f">$l</span> = <span style="color:#000-2">$</span>(<span style="color:#a11">'.al_post_list'</span>, <span style="color:#000-2">$a</span>),<br>			<span style="color:#00f">$l_f</span> = <span style="color:#000-2">$</span>(<span style="color:#a11">'.al_post_list:first'</span>, <span style="color:#000-2">$a</span>);<br>		<span style="color:#000-2">$l</span>.<span style="color:#000">hide</span>();<br>		<span style="color:#000-2">$l_f</span>.<span style="color:#000">show</span>();<br>		<span style="color:#000-2">$m</span>.<span style="color:#000">css</span>(<span style="color:#a11">'cursor'</span>, <span style="color:#a11">'s-resize'</span>).<span style="color:#000">on</span>(<span style="color:#a11">'click'</span>, <span style="color:#708">function</span>(){<br>			<span style="color:#000-2">$</span>(<span style="color:#000-2">this</span>).<span style="color:#000">next</span>().<span style="color:#000">slideToggle</span>(<span style="color:#164">400</span>);<br>		});<br>		<span style="color:#708">var</span> <span style="color:#00f">animate</span> = <span style="color:#708">function</span>(<span style="color:#00f">index</span>, <span style="color:#00f">status</span>, <span style="color:#00f">s</span>) {<br>			<span style="color:#708">if</span> (<span style="color:#000-2">index</span> &gt; <span style="color:#000-2">$l</span>.<span style="color:#000">length</span>) {<br>				<span style="color:#708">return</span>;<br>			}<br>			<span style="color:#708">if</span> (<span style="color:#000-2">status</span> == <span style="color:#a11">'up'</span>) {<br>				<span style="color:#000-2">$l</span>.<span style="color:#000">eq</span>(<span style="color:#000-2">index</span>).<span style="color:#000">slideUp</span>(<span style="color:#000-2">s</span>, <span style="color:#708">function</span>() {<br>					<span style="color:#000-2">animate</span>(<span style="color:#000-2">index</span>+<span style="color:#164">1</span>, <span style="color:#000-2">status</span>, (<span style="color:#000-2">s</span>-<span style="color:#164">10</span>&lt;<span style="color:#164">1</span>)?<span style="color:#164">0</span>:<span style="color:#000-2">s</span>-<span style="color:#164">10</span>);<br>				});<br>			} <span style="color:#708">else</span> {<br>				<span style="color:#000-2">$l</span>.<span style="color:#000">eq</span>(<span style="color:#000-2">index</span>).<span style="color:#000">slideDown</span>(<span style="color:#000-2">s</span>, <span style="color:#708">function</span>() {<br>					<span style="color:#000-2">animate</span>(<span style="color:#000-2">index</span>+<span style="color:#164">1</span>, <span style="color:#000-2">status</span>, (<span style="color:#000-2">s</span>-<span style="color:#164">10</span>&lt;<span style="color:#164">1</span>)?<span style="color:#164">0</span>:<span style="color:#000-2">s</span>-<span style="color:#164">10</span>);<br>				});<br>			}<br>		};<br>		<span style="color:#000-2">$</span>(<span style="color:#a11">'#al_expand_collapse'</span>).<span style="color:#000">on</span>(<span style="color:#a11">'click'</span>, <span style="color:#708">function</span>(<span style="color:#00f">e</span>){<br>			<span style="color:#000-2">e</span>.<span style="color:#000">preventDefault</span>();<br>			<span style="color:#708">if</span> ( <span style="color:#000-2">$</span>(<span style="color:#000-2">this</span>).<span style="color:#000">data</span>(<span style="color:#a11">'s'</span>) ) {<br>				<span style="color:#000-2">$</span>(<span style="color:#000-2">this</span>).<span style="color:#000">data</span>(<span style="color:#a11">'s'</span>, <span style="color:#a11">''</span>);<br>				<span style="color:#000-2">animate</span>(<span style="color:#164">0</span>, <span style="color:#a11">'up'</span>, <span style="color:#164">100</span>);<br>			} <span style="color:#708">else</span> {<br>				<span style="color:#000-2">$</span>(<span style="color:#000-2">this</span>).<span style="color:#000">data</span>(<span style="color:#a11">'s'</span>, <span style="color:#164">1</span>);<br>				<span style="color:#000-2">animate</span>(<span style="color:#164">0</span>, <span style="color:#a11">'down'</span>, <span style="color:#164">100</span>);<br>			}<br>		});<br>	});<br>})(<span style="color:#000">jQuery</span>, <span style="color:#000">window</span>);</pre>

PS：不知道怎么写 js 文件然后调用的朋友就直接打开 header.php 并找到 <?php wp_head(); ?>，在其下面加上

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">&lt;<span style="color:#000">script</span> <span style="color:#000">type</span>=<span style="color:#a11">"text/javascript"</span>&gt;<span style="color:#000">上</span><span style="color:#000">面</span><span style="color:#000">那</span><span style="color:#000">段</span> <span style="color:#000">jQuery</span> <span style="color:#000">代</span><span style="color:#000">码</span>&lt;<span style="color:#a11">/script&gt;</span></pre>

因为是放在主题的 the_content() 下面，所以会默认使用主题写好的 h3 ul li 格式，如果要更加有特色，那么就要自己去修改 css 了。

<span style = "color:blue;">Thanks zww 大叔</span>：http://zww.me/wordpress-archive-page-template-wp-primary-function-2014-edition.z-turn

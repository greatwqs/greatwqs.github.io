---
layout: post
title: WordPress 评论回复邮件通知代码
date: 2012-10-19 23:01
author: 老杨
comments: true
categories: [wordpress, 老杨转载]
---
这是自用的评论回复邮件通知代码，源码来自 <a href="http://kan.willin.org/" target="_blank">Willin</a>、<a href="http://www.qiqiboy.com/" target="_blank">Qiqiboy</a>，有兴趣者可以去这两位作者博客看看。

这版本的评论回复通知是支持嵌套和@用户方式的。

用法很简单，把下面的代码扔到主题的 functions.php 里面即可（原则上要打开 WordPress 原生嵌套，具体木有去研究。）

<!--more-->


<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444"> /* 邮件通知 by Qiqiboy */<br> function comment_mail_notify($comment_id) {<br>     $comment = get_comment($comment_id);//根据id获取这条评论相关数据<br>     $content=$comment-&gt;comment_content;<br>     //对评论内容进行匹配<br>     $match_count=preg_match_all('/<span style="color:#170">&lt;a</span> <span style="color:#00c">href</span>=<span style="color:#a11">"#comment-([0-9]+)?"</span> <span style="color:#00c">rel</span>=<span style="color:#a11">"nofollow"</span><span style="color:#170">&gt;</span>/si',$content,$matchs);<br>     if($match_count&gt;0){//如果匹配到了<br>         foreach($matchs[1] as $parent_id){//对每个子匹配都进行邮件发送操作<br>             SimPaled_send_email($parent_id,$comment);<br>         }<br>     }elseif($comment-&gt;comment_parent!='0'){//以防万一，有人故意删了@回复，还可以通过查找父级评论id来确定邮件发送对象<br>         $parent_id=$comment-&gt;comment_parent;<br>         SimPaled_send_email($parent_id,$comment);<br>     }else return;<br> }<br> add_action('comment_post', 'comment_mail_notify');<br> function SimPaled_send_email($parent_id,$comment){//发送邮件的函数 by Qiqiboy.com<br>     $admin_email = get_bloginfo ('admin_email');//管理员邮箱<br>     $parent_comment=get_comment($parent_id);//获取被回复人（或叫父级评论）相关信息<br>     $author_email=$comment-&gt;comment_author_email;//评论人邮箱<br>     $to = trim($parent_comment-&gt;comment_author_email);//被回复人邮箱<br>     $spam_confirmed = $comment-&gt;comment_approved;<br>     if ($spam_confirmed != 'spam' <span style="color:#219">&amp;&amp; $to != $admin_email &amp;&amp; $to != $author_email) {</span><br>         $wp_email = 'no-reply@' . preg_replace('#^www\.#', '', strtolower($_SERVER['SERVER_NAME'])); // e-mail 發出點, no-reply 可改為可用的 e-mail.<br>         $subject = '您在 [' . get_option("blogname") . '] 的留言有了回應';<br>         $message = '<span style="color:#170">&lt;div</span> <span style="color:#00c">style</span>=<span style="color:#a11">"background-color:#eef2fa;border:1px solid #d8e3e8;color:#111;padding:0 15px;-moz-border-radius:5px;-webkit-border-radius:5px;-khtml-border-radius:5px;"</span><span style="color:#170">&gt;</span><br>             <span style="color:#170">&lt;p</span><span style="color:#170">&gt;</span>' . trim(get_comment($parent_id)-&gt;comment_author) . ', 您好!<span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><br>             <span style="color:#170">&lt;p</span><span style="color:#170">&gt;</span>您曾在《' . get_the_title($comment-&gt;comment_post_ID) . '》的留言:<span style="color:#170">&lt;br</span> <span style="color:#170">/&gt;</span>'<br>             . trim(get_comment($parent_id)-&gt;comment_content) . '<span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><br>             <span style="color:#170">&lt;p</span><span style="color:#170">&gt;</span>' . trim($comment-&gt;comment_author) . ' 给你的回复:<span style="color:#170">&lt;br</span> <span style="color:#170">/&gt;</span>'<br>             . trim($comment-&gt;comment_content) . '<span style="color:#170">&lt;br</span> <span style="color:#170">/&gt;</span><span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><br>             <span style="color:#170">&lt;p</span><span style="color:#170">&gt;</span>您可以点击 <span style="color:#170">&lt;a</span> <span style="color:#00c">href</span>=<span style="color:#a11">"' . htmlspecialchars(get_comment_link($parent_id,array("</span><span style="color:#00c">type</span><span style="color:#a11">" =&gt; "</span><span style="color:#@cm-word">all</span><span style="color:#a11">"))) . '"</span><span style="color:#170">&gt;</span>查看回复的完整內容<span style="color:#f00">&lt;/a</span><span style="color:#f00">&gt;</span><span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><br>             <span style="color:#170">&lt;p</span><span style="color:#170">&gt;</span>欢迎再度光临 <span style="color:#170">&lt;a</span> <span style="color:#00c">href</span>=<span style="color:#a11">"' . get_option('home') . '"</span><span style="color:#170">&gt;</span>' . get_option('blogname') . '<span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><br>             <span style="color:#170">&lt;p</span><span style="color:#170">&gt;</span>(此邮件有系统自动发出, 请勿回复.)<span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span>';<br>         $from = "From: \"" . get_option('blogname') . "\" <span style="color:#170">&lt;$wp_email</span><span style="color:#170">&gt;</span>";<br>         $headers = "$from\nContent-Type: text/html; charset=" . get_option('blog_charset') . "\n";<br>         wp_mail( $to, $subject, $message, $headers );<br>     }<br> }</pre>

via  zww - http://zww.me/archives/25536

<span style = "color:red;">-----------------分割线---------------------</span>

<span style = "color:blue;">Update：</span><a href="http://fatesinger.com/75036" target="_blank">大发</a>版 - 2015-02-22

下面代码加到functions.php中

<pre style="margin:15px 0;font:100 12px/18px monaco, andale mono, courier new;padding:10px 12px;border:#ccc 1px solid;border-left-width:4px;background-color:#fefefe;box-shadow:0 0 4px #eee;word-break:break-all;word-wrap:break-word;color:#444">/**<br> * mail when reply to someone<br> *<br> * @since Pure 1.0<br> */<br>function comment_mail_notify($comment_id) {<br>    $comment = get_comment($comment_id);<br>    $parent_id = $comment-&gt;comment_parent ? $comment-&gt;comment_parent : '';<br>    $spam_confirmed = $comment-&gt;comment_approved;<br>    $logo = get_template_directory_uri().'/images/logo.png';//LOGO 地址<br>    if (($parent_id != '') <span style="color:#219">&amp;&amp; ($spam_confirmed != 'spam') &amp;&amp; (get_option('admin_email') != get_comment($parent_id)-&gt;comment_author_email)) {</span><br>        $wp_email = 'no-reply@' . preg_replace('#^www\.#', '', strtolower($_SERVER['SERVER_NAME'])); //可以修改为你自己的邮箱地址<br>        $to = trim(get_comment($parent_id)-&gt;comment_author_email);<br>        $subject = '你在 [' . get_option("blogname") . '] 的留言有了新回复';<br>        $message = '<span style="color:#170">&lt;table</span> <span style="color:#00c">class</span>=<span style="color:#a11">"email"</span> <span style="color:#00c">style</span>=<span style="color:#a11">" width: 600px; margin-top: 10px; margin-right: auto; margin-bottom: 0; margin-left: auto; font-size: 16px; line-height: 1.4;"</span><span style="color:#170">&gt;</span><br>    <span style="color:#170">&lt;tbody</span><span style="color:#170">&gt;</span><br>    <span style="color:#170">&lt;tr</span><span style="color:#170">&gt;</span><br>        <span style="color:#170">&lt;td</span> <span style="color:#00c">style</span>=<span style="color:#a11">"padding-top:40px;padding-right:5%;padding-bottom:46px;padding-left:5%;color:#333332"</span><span style="color:#170">&gt;</span><br>            <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"email-header"</span> <span style="color:#00c">style</span>=<span style="color:#a11">"margin-bottom: 20px;"</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;div</span> <span style="color:#00c">class</span>=<span style="color:#a11">"email-logo-wrapper"</span> <span style="color:#00c">style</span>=<span style="color:#a11">"width: 50px; margin-top: 0; margin-right: auto; margin-bottom: 0; margin-left: auto;"</span><span style="color:#170">&gt;</span><br>                    <span style="color:#170">&lt;img</span> <span style="color:#00c">class</span>=<span style="color:#a11">"email-logo"</span> <span style="color:#00c">style</span>=<span style="color:#a11">"display: block; width: 50px;"</span> <span style="color:#00c">src</span>=<span style="color:#a11">"'. $logo .'"</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br>            <span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br>            <span style="color:#170">&lt;div</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;p</span> <span style="color:#00c">style</span>=<span style="color:#a11">"margin-top:0;margin-right:0;margin-bottom:20px;margin-left:0;font-size:18px;line-height:1.4;text-align:center;color:#333332"</span><span style="color:#170">&gt;</span>' . trim(get_comment($parent_id)-&gt;comment_author) . '，你好。<span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;p</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;span</span> <span style="color:#00c">style</span>=<span style="color:#a11">"color:#3eae5f;"</span><span style="color:#170">&gt;</span>' . trim($comment-&gt;comment_author) . '<span style="color:#170">&lt;/span</span><span style="color:#170">&gt;</span> 回复了您在文章<span style="color:#170">&lt;strong</span> <span style="color:#00c">style</span>=<span style="color:#a11">"font-weight:bold"</span><span style="color:#170">&gt;</span>' . get_the_title($comment-&gt;comment_post_ID) . '<span style="color:#170">&lt;/strong</span><span style="color:#170">&gt;</span>中的评论"' . trim(get_comment($parent_id)-&gt;comment_content) . '"<span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;hr</span> <span style="color:#00c">style</span>=<span style="color:#a11">"width:50px;border:0;border-bottom:1px solid #e5e5e5;margin-top:20px"</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;p</span> <span style="color:#00c">style</span>=<span style="color:#a11">"margin-top:20px;margin-right:0;margin-bottom:20px;margin-left:0"</span><span style="color:#170">&gt;</span>If you like what you read,  keep the conversation going!<span style="color:#170">&lt;/p</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;div</span> <span style="color:#00c">style</span>=<span style="color:#a11">"margin-top:30px;padding-top:26px;border-top:1px solid #e5e5e5;font-size:16px;color:#333332;overflow:hidden"</span><span style="color:#170">&gt;</span><br>                    <span style="color:#170">&lt;div</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;a</span> <span style="color:#00c">target</span>=<span style="color:#a11">"_blank"</span> <span style="color:#00c">style</span>=<span style="color:#a11">"text-decoration:none;display:block;width:50px;float:left;margin-left:0;line-height:0;margin-right:10px;margin-top:5px"</span> <span style="color:#00c">href</span>=<span style="color:#a11">"' . htmlspecialchars(get_comment_link($parent_id)) . '"</span><span style="color:#170">&gt;</span>'. get_avatar($comment-&gt;comment_author_email,50). '<span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span>' . trim($comment-&gt;comment_content) . '<span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br>                    <span style="color:#170">&lt;div</span> <span style="color:#00c">style</span>=<span style="color:#a11">"padding-top:0;padding-right:0;padding-bottom:0;padding-left:0;margin-top:10px;margin-right:0;margin-bottom:0;margin-left:60px;overflow:hidden"</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;a</span> <span style="color:#00c">target</span>=<span style="color:#a11">"_blank"</span> <span style="color:#00c">style</span>=<span style="color:#a11">"color:#ffffff;text-decoration:none;display:inline-block;min-height:26px;line-height:27px;padding-top:0;padding-right:16px;padding-bottom:0;padding-left:16px;outline:0;background:#3eae5f;font-size:12px;text-align:center;font-style:normal;font-weight:400;border:0;vertical-align:bottom;white-space:nowrap;border-radius:999em"</span> <span style="color:#00c">href</span>=<span style="color:#a11">"' . htmlspecialchars(get_comment_link($parent_id)) . '"</span><span style="color:#170">&gt;</span>查看<span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span><span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br>                <span style="color:#170">&lt;div</span> <span style="color:#00c">style</span>=<span style="color:#a11">"color:#b3b3b1;font-size:14px;text-align:center;padding-top:0;padding-right:0;padding-bottom:0;padding-left:0;margin-top:50px;margin-right:0;margin-left:0"</span><span style="color:#170">&gt;</span>本邮件由' . get_option("blogname") . '自动生成，<span style="color:#170">&lt;span</span> <span style="color:#00c">style</span>=<span style="color:#a11">"color:#3eae5f"</span><span style="color:#170">&gt;</span>请勿回复<span style="color:#170">&lt;/span</span><span style="color:#170">&gt;</span>。<span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br>            <span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br>        <span style="color:#170">&lt;/td</span><span style="color:#170">&gt;</span><br>    <span style="color:#170">&lt;/tr</span><span style="color:#170">&gt;</span><br>    <span style="color:#170">&lt;tr</span><span style="color:#170">&gt;</span><br>        <span style="color:#170">&lt;td</span> <span style="color:#00c">style</span>=<span style="color:#a11">"padding-top:0;padding-right:0;padding-bottom:0;padding-left:0;font-size:12px;text-align:center;color:#b3b3b1"</span><span style="color:#170">&gt;</span><br>            <span style="color:#170">&lt;div</span> <span style="color:#00c">style</span>=<span style="color:#a11">"padding-top:13px;border-top:1px solid #e5e5e5"</span><span style="color:#170">&gt;</span>Sent by <span style="color:#170">&lt;a</span> <span style="color:#00c">target</span>=<span style="color:#a11">"_blank"</span> <span style="color:#00c">style</span>=<span style="color:#a11">"color:#b3b3b1"</span> <span style="color:#00c">href</span>=<span style="color:#a11">"' . home_url() . '"</span><span style="color:#170">&gt;</span>' . get_option("blogname") . '<span style="color:#170">&lt;/a</span><span style="color:#170">&gt;</span> · Since 2011 <span style="color:#170">&lt;/div</span><span style="color:#170">&gt;</span><br>        <span style="color:#170">&lt;/td</span><span style="color:#170">&gt;</span><br>    <span style="color:#170">&lt;/tr</span><span style="color:#170">&gt;</span><br>    <span style="color:#170">&lt;/tbody</span><span style="color:#170">&gt;</span><br><span style="color:#170">&lt;/table</span><span style="color:#170">&gt;</span>';<br>        $from = "From: \"" . get_option('blogname') . "\" <span style="color:#170">&lt;$wp_email</span><span style="color:#170">&gt;</span>";<br>        $headers = "$from\nContent-Type: text/html; charset=" . get_option('blog_charset') . "\n";<br>        wp_mail( $to, $subject, $message, $headers );<br>    }<br>}<br>add_action('comment_post', 'comment_mail_notify');</pre>
